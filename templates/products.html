{% extends "base.html" %}

{% block title %}Products - {{ category }}{% endblock %}

{% block content %}
<div class="products-page">
    <div class="page-header">
        <h1>{{ category }} Products</h1>
        <a href="{{ url_for('homepage') }}" class="btn btn-secondary">← Back to Homepage</a>
    </div>
    
    {% if products %}
        <div class="products-grid">
            {% for product in products %}
                <div class="product-card">
                    <div class="product-image-container">
                        {% if product.image_url %}
                            <img src="{{ product.image_url }}" 
                                 alt="{{ product.category }} {{ product.color }}" 
                                 class="product-image"
                                 style="width: 100%; height: 100%; object-fit: cover; display: block; background: #f5f5f5;"
                                 onerror="this.onerror=null; this.src='{{ url_for('static', filename='images/tshirt.png') }}'; console.log('Image failed, using local fallback');"
                                 loading="lazy">
                        {% else %}
                            <img src="{{ url_for('static', filename='images/tshirt.png') }}" 
                                 alt="{{ product.category }} {{ product.color }}" 
                                 class="product-image"
                                 style="width: 100%; height: 100%; object-fit: cover; display: block; background: #f5f5f5;"
                                 onerror="this.onerror=null; this.src='https://via.placeholder.com/400x400/2874f0/ffffff?text={{ product.category|replace(' ', '+') }}';"
                                 loading="lazy">
                        {% endif %}
                        {% if product.stock > 0 %}
                            <span class="stock-badge">In Stock</span>
                        {% else %}
                            <span class="stock-badge out-of-stock">Out of Stock</span>
                        {% endif %}
                    </div>
                    <div class="product-info">
                        <h3>{{ product.category }}</h3>
                        <p><strong>Size:</strong> {{ product.size }}</p>
                        <p><strong>Color:</strong> <span class="color-badge" style="background-color: {{ product.color.lower() }}">{{ product.color }}</span></p>
                        <p><strong>Stock:</strong> {{ product.stock }} available</p>
                        {% if product.needs_validation %}
                            <p class="text-warning" style="font-size: 0.85em; margin-top: 5px;">
                                ⚠ Some items pending validation
                            </p>
                        {% endif %}
                    </div>
                    
                    <div class="product-actions">
                        {% if product.stock > 0 %}
                            <form class="add-to-cart-form" onsubmit="addToCart(event, {{ product.id }})">
                                <div class="quantity-selector">
                                    <label>Quantity:</label>
                                    <input type="number" name="quantity" value="1" min="1" max="{{ product.stock }}" class="form-control" required>
                                </div>
                                <button type="submit" class="btn btn-primary" style="width: 100%;">Add to Cart</button>
                            </form>
                        {% else %}
                            <form onsubmit="notifyMe(event, {{ product.id }})">
                                <button type="submit" class="btn btn-secondary" style="width: 100%;">Notify Me</button>
                            </form>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="no-products">
            <p>No products available in this category.</p>
            <a href="{{ url_for('homepage') }}" class="btn btn-primary">Back to Homepage</a>
        </div>
    {% endif %}
</div>

<script>
function addToCart(event, productId) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    formData.append('product_id', productId);
    
    fetch('{{ url_for("add_to_cart") }}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            form.reset();
        } else {
            alert(data.message);
        }
    })
    .catch(error => {
        alert('Error adding to cart');
    });
}

function notifyMe(event, productId) {
    event.preventDefault();
    const formData = new FormData();
    formData.append('product_id', productId);
    
    fetch('{{ url_for("notify_me") }}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('You will be notified when this product is back in stock!');
        }
    });
}
</script>
{% endblock %}


